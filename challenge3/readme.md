### Refactoring Details

1. Consolidate conditional expressions
2. Replace magic numbers with named constants
3. Use a defaultdict to simplify code and handle missing keys
4. Use input validation for error handling